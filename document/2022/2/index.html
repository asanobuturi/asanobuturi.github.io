<!doctype html><html lang=ja><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=description content="Stable DiffusionというAI画像生成ソフトをインストールして絵をかいてみます"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/styles.css><link rel=subresource class=lazy-css href=/css/highlight.css><link rel=icon href=/image/favicon.svg type=image/svg+xml><link rel="icon alternate" href=/images/favicon.ico><meta property="og:site_name" content="浅野学園物理部"><meta property="og:url" content="https://asanobuturi.github.io/document/2022/2/index.html"><meta property="og:title" content="Stable Diffusionをインストールしてお絵かきする｜浅野学園物理部"><meta property="og:description" content="Stable DiffusionというAI画像生成ソフトをインストールして絵をかいてみます"><meta property="og:type" content="website"><meta property="og:image" content="https://asanobuturi.github.io/thumbnails/document/2022/2/thumbnail.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@Uchi54_APC"><script src=/general.js></script><link rel=stylesheet href=/css/article.css><script src=https://kit.fontawesome.com/1e291c4f9b.js crossorigin=anonymous></script><title>Stable Diffusionをインストールしてお絵かきする｜浅野学園物理部</title><script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML"></script><style>.document table th{background-color:#fff}</style></head><body><div id=nav-drawer><input id=nav-input type=checkbox class=nav-unshown>
<label id=nav-open for=nav-input><span class="bar bar1"></span><span class="bar bar2"></span><span class="bar bar3"></span><span class=menu>MENU</span>
<span class=close>CLOSE</span></label>
<label id=nav-close for=nav-input></label><div id=nav-content><a href=/index.html><img loading=lazy src=/image/favicon.svg id=nav-logo alt=浅野学園物理部></a>
<a class=nav-link href=/index.html>ホーム</a>
<a class=nav-link href=/about/index.html>物理部とは</a>
<a class="nav-link isActive" href=/document/index.html>部誌</a>
<a class=nav-link href=/game/index.html>ゲーム</a>
<a class=nav-link href=/blog/index.html>ブログ</a>
<a class=nav-link href=/electronic/index.html>電工の部屋</a><div class=nav-separator></div><a class=nav-link href=http://d.hatena.ne.jp/apc/>ブログ(外部サイト)</a></div></div><main><div id=main><div class=documentcontent><div id=breadcrumbs><i class="fas fa-home"></i><a href=/index.html>ホーム</a>
<i class="fas fa-angle-right"></i><a href=../../index.html>部誌</a>
<i class="fas fa-angle-right"></i><a href=../index.html>2022年度部誌</a>
<i class="fas fa-angle-right"></i><a href=./index.html>Stable Diffusionをインストールしてお絵かきする</a></div><header class=documenttitle><h1 id=title>Stable Diffusionをインストールしてお絵かきする</h1><p class=author><i class="fas fa-user-edit"></i>中２ S.K.</p><a href="https://twitter.com/intent/tweet?text=Stable%20Diffusion%e3%82%92%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab%e3%81%97%e3%81%a6%e3%81%8a%e7%b5%b5%e3%81%8b%e3%81%8d%e3%81%99%e3%82%8b&via=Uchi54_APC&related=Uchi54_APC" class=twitter-share-button data-show-count=false>ツイート</a>
<script async src=https://platform.twitter.com/widgets.js></script></header><div class=document><h2 id=はじめに>はじめに</h2><p>物理部中２のPC班員です。中３から部誌を書こうと思っていましたが、ちょうどいいネタが転がり込んできたので書くことにしました。</p><h2 id=使うライブラリのインストール>使うライブラリのインストール</h2><p>今回使うStable Diffusionは最近オープンソース化され、商用利用も可能という素晴らしいライブラリです。
PCの推奨スペックはVRAM10G以上のnvidiaのGPUで、今回はRTX3060というGPUを使っていきます。</p><h3 id=リポジトリにアクセスするためのトークンを作る>リポジトリにアクセスするためのトークンを作る</h3><p>まず<a href=https://huggingface.co>ここ</a>にアクセスして右上の<code>Sign Up</code>からアカウントを作成し、次に<a href=https://huggingface.co/CompVis/stable-diffusion-v1-4>ここ</a>にアクセスして<code>Access repository</code>をクリックした後、サイト右上のアカウントアイコンをクリックして<code>Settings</code>から左の<code>Access Tokens</code>からトークンを作成する。このトークンが後で必要になるのでメモしておく。</p><p><img src=./tokens.png alt=CreateTokens></p><h3 id=必要なソフトとライブラリ>必要なソフトとライブラリ</h3><h4 id=python>Python</h4><p>まずは今回のコードを書くためにプログラミング言語のPythonをインストールする。
<a href=http://python.org>Python公式サイト</a>からpythonのインストーラーをダウンロードしてインストールする。インストール時にPythonをパスに追加するオプションを選択するのを忘れずに。</p><p><img src=./install_python.png alt=Python>{width=400}</p><h4 id=ドライバ>ドライバ</h4><p><img src=./nvidia_driver.png alt=Driver title=ドライバダウンロード>{width=400}</p><p>今回はAIの演算にCUDAというnvidia製のグラフィックボードについているものを使うので、<a href="https://www.nvidia.co.jp/Download/index.aspx?lang=jp">ここ</a>からドライバを手に入れてインストールする。</p><h4 id=cuda-toolkit>CUDA Toolkit</h4><p><a href=https://developer.nvidia.com/cuda-downloads>ここ</a>からダウンロードしてインストールする。
そしてコマンドプロンプトで<code>nvcc -V</code>を実行して正常にインストールされているかを確認する。
このとき<code>release</code>の後にある数字をメモしておく。</p><h4 id=cudnn>cuDNN</h4><p><a href=https://developer.nvidia.com/rdp/cudnn-download>ここ</a>からダウンロードして解凍した<code>bin</code>フォルダにパスを通す。
この時、ダウンロードにnvidiaデベロッパーアカウントが必要なので作成する。</p><h4 id=pytorch>PyTorch</h4><p><a href=https://pytorch.org/get-started/locally/>ここ</a>からPyTorchをインストールするためのコマンドを生成する。</p><ul><li>PyTorch Build: Stable</li><li>Your OS:使用しているコンピュータのOSを選択</li><li>Package:Pip</li><li>Language:Python</li><li>Compute Platform:先ほどメモしたReleaseの数字に合うものを選択
その後、生成されたコマンド(<code>Run this Command</code>にある文字列)を実行してPyTorchをインストールする。
インストール後、以下のコマンドでPyTorchからGPUが使用可能かを試す。Trueになれば使用可能。</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>PS C:\Users\hoge&gt; python
Python 3.10.6 (tags/v3.10.6:9c7b4bd, Aug  1 2022, 21:53:49) [MSC v.1932 64 bit (AMD64)] on win32
Type &#34;help&#34;, &#34;copyright&#34;, &#34;credits&#34; or &#34;license&#34; for more information.
&gt;&gt;&gt; import torch #時間がかかるので注意
&gt;&gt;&gt; torch.cuda.is_available()
True
&gt;&gt;&gt;
</code></pre></div><h4 id=その他>その他</h4><p>ライブラリを使用するためのライブラリをインストールする。コマンドプロンプトで
<code>pip install diffusers==0.2.4 transformers scipy ftfy</code>
を実行する。</p><h2 id=生成>生成</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> torch
<span style=color:#f92672>from</span> torch <span style=color:#f92672>import</span> autocast
<span style=color:#f92672>from</span> diffusers <span style=color:#f92672>import</span> StableDiffusionPipeline

pipe <span style=color:#f92672>=</span> StableDiffusionPipeline<span style=color:#f92672>.</span>from_pretrained(
        <span style=color:#e6db74>&#34;CompVis/stable-diffusion-v1-4&#34;</span>,
        revision<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;fp16&#34;</span>,
        torch_dtype<span style=color:#f92672>=</span>torch<span style=color:#f92672>.</span>float16,
        use_auth_token<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ここにさっき作成したトークンを入力&#34;</span>
    )
pipe <span style=color:#f92672>=</span> pipe<span style=color:#f92672>.</span>to(<span style=color:#e6db74>&#34;cuda&#34;</span>)
prompt <span style=color:#f92672>=</span> input(<span style=color:#e6db74>&#34;prompt:&#34;</span>)
pipe<span style=color:#f92672>.</span>safety_checker <span style=color:#f92672>=</span> <span style=color:#66d9ef>lambda</span> images, <span style=color:#f92672>**</span>kwargs: (images, False)

<span style=color:#66d9ef>with</span> autocast(<span style=color:#e6db74>&#34;cuda&#34;</span>):
    image <span style=color:#f92672>=</span> pipe(prompt)[<span style=color:#e6db74>&#34;sample&#34;</span>][<span style=color:#ae81ff>0</span>]
image<span style=color:#f92672>.</span>save(f<span style=color:#e6db74>&#34;{prompt}.png&#34;</span>)
</code></pre></div><p>以上のコマンドをpythonで実行することで実行したディレクトリに画像が生成される。</p><h2 id=生成したお気に入りの画像たち>生成したお気に入りの画像たち</h2><table><thead><tr><th style=text-align:center></th><th style=text-align:center></th></tr></thead><tbody><tr><td style=text-align:center><img src=./sample1.png alt></td><td style=text-align:center><img src=./sample2.png alt></td></tr><tr><td style=text-align:center><img src=./sample3.png alt></td><td style=text-align:center><img src=./sample4.png alt></td></tr></tbody></table><h2 id=参考文献>参考文献</h2><p><a href=https://huggingface.co>https://huggingface.co</a></p><p><a href=https://zenn.dev/ryu2021/articles/3d5737408b06fe>https://zenn.dev/ryu2021/articles/3d5737408b06fe</a></p><p><a href=https://twitter.com/kawai_nae/status/1561843126842851328>https://twitter.com/kawai_nae/status/1561843126842851328</a></p></div><nav class=nextPrev><div class=next>次へ<a href=https://asanobuturi.github.io/document/2022/3/>プラレールの改造について＞</a></div><div class=next>前へ<a href=https://asanobuturi.github.io/document/2022/1/>部長挨拶＞</a></div></nav></div><nav id=sidebar><div id=sidemenu><div class=side-back><a href=../index.html>記事の一覧へもどる<i class="fas fa-sign-out-alt"></i></a></div><div class=side-prev><a href=https://asanobuturi.github.io/document/2022/1/><i class="fas fa-angle-left"></i>部長挨拶</a></div><div class=side-next><a href=https://asanobuturi.github.io/document/2022/3/>プラレールの改造について<i class="fas fa-angle-right"></i></a></div></div><div id=indexblock><div class=indextitle>目次</div><ol class=indexcontents><nav id=TableOfContents><ul><li><a href=#はじめに>はじめに</a></li><li><a href=#使うライブラリのインストール>使うライブラリのインストール</a><ul><li><a href=#リポジトリにアクセスするためのトークンを作る>リポジトリにアクセスするためのトークンを作る</a></li><li><a href=#必要なソフトとライブラリ>必要なソフトとライブラリ</a></li></ul></li><li><a href=#生成>生成</a></li><li><a href=#生成したお気に入りの画像たち>生成したお気に入りの画像たち</a></li><li><a href=#参考文献>参考文献</a></li></ul></nav></ol></div></nav></div><footer class=footer><p class=copyright>Copyright &copy; 2015 - 2022 Asano Physics Club, All Rights Reversed.</p></footer></main></body></html>