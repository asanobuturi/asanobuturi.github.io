<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-115439668-1"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
          dataLayer.push(arguments);
      }
      gtag('js', new Date());
      gtag('config', 'UA-115439668-1');
  </script>

  <meta property="og:url" content="https://asanobuturi.github.io/document/2022/PC98APCOS/index.html"/>
  <meta property="og:title" content="自作OSで文字列をPC98に表示する|浅野学園物理部"/>
  <meta property="og:description" content=""/>
  <meta property="og:type" content="website"/>
  <meta property="og:image" content="https://asanobuturi.github.io/document/2022/PC98APCOS/thumbnail.jpg"/><!--ここまでOGP設定-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="@Uchi54_APC" /> <!--ここまでTwitterカード設定-->

  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-MML-AM_CHTML' async></script><!--MathJax適用(LaTeX数式表示用)-->

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <meta name="description" content="文化祭で展示していたやつの簡単な解説です" />

  <title>自作OSで文字列をPC98に表示する|浅野学園物理部</title>

  <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>

  <link rel="stylesheet" href="https://asanobuturi.github.io/styles.css">
  <link rel="stylesheet" href="https://asanobuturi.github.io/blog_new.css">
  <link rel="stylesheet" href="https://asanobuturi.github.io/highlight.css"><!--シンタックスハイライト-->
  <link rel="shortcut icon" href="https://asanobuturi.github.io/image/favicon.ico">

  <script type="text/javascript" src="//typesquare.com/accessor/script/typesquare.js?YME8OdI00sA%3D" charset="utf-8"></script>
  <script src="https://kit.fontawesome.com/1e291c4f9b.js" crossorigin="anonymous"></script>

</head>
<body>
  <div id="nav-drawer">
  </div>
  <main>
    <div id="main">
        <div class="documentcontent"><article>
            <div id="breadcrumbs">
            </div>
            <header class="documenttitle">
                <h1 id="title"></h1>
                <p class="author"></p>
                <a href="https://twitter.com/intent/tweet?url=https://asanobuturi.github.io/document/2022/PC98APCOS/index.html&text=自作OSで文字列をPC98に表示する|浅野学園物理部&via=Uchi54_APC&related=Uchi54_APC" class="twitter-share-button" data-show-count="false">Tweet</a>
                <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><!--Twitterのシェアボタンの中身(URL・記事タイトル)も記述すること-->
            </header>
            <div class="document">
              <h2 id="はじめに">はじめに</h2>
              <p>二度目の登場の高2のN.Kです。展示用に作ったものの簡単な解説をしようと思います。</p>
              <h2 id="実際の展示">実際の展示</h2>
              <p>まず文化祭で展示する物を紹介しようと思います。<br />
              画像の通りPC98で<code>THANK YOU FOR COMING TO APC</code>と表示させています。</p>
              <figure>
              <img src="eALzXyI.jpg" width="500" alt="展示" />
              <figcaption aria-hidden="true">展示</figcaption>
              </figure>
              <h2
              id="基本的なプログラムの仕組み">基本的なプログラムの仕組み</h2>
              <p>ざっくり言うとメモリーの中のテキストVRAMに割り当てられている領域にASCII文字コードを書き込んで文字を表示しています。<br />
              一定の周期でコンピュータがテキストVRAMの内容を読み込んでモニターへ送るようになっているので、テキストVRAMに文字を書き込むと書き込んだ番地に応じた画面上の位置に文字が表示されます。</p>
              <h2 id="実際のコード">実際のコード</h2>
              <p>今回はアセンブリ言語というプログラミング言語を使用します。<br />
              <a href="https://github.com/asanobuturi/PC98APCOS"
              class="uri">https://github.com/asanobuturi/PC98APCOS</a>
              で全体のコードを公開しています。<br />
              はじめはフロッピーディスクの情報を指定します。<br />
              1行目の<code>JMP entry</code>で文字を書くプログラムの場所を示しています<code>JMP</code>命令はC言語でいうところのgoto文と同じです。<br />
              2行目はNOP命令でCPUに何もしないで一命令分の実行時間を消費するものだそうです。なぜこれが必要なのかはよくわかりませんがこれが一般的だそうです。<br />
              3行目はブートセクタの名前を8byteで指定しています。ブートセクタとは起動に必要なプログラムや情報を記録したものです。<br />
              4行目は1セクタの大きさを指定しています。セクタとは円盤型の記憶媒体の最小の記録単位でフロッピーの場合は512byteなので512を指定します。<br />
              5行目はクラスタあたりのセクタ数を指定しています。<br />
              クラスタとはOSが記録媒体を管理する際の最小単位で2の累乗である必要があり、今回は1クラスタあたり1セクタとしています。<br />
              6行目は予約領域のセクタ数を指定しています。<br />
              予約領域とはPCの起動に必要なプログラムのことですなわちこのプログラム自身です。ディスクのはじめにこれがあるので1を指定しています。<br />
              7行目はFATの個数で2を指定するのが一般的だそうです。<br />
              8行目はルートディレクトリでのファイルの情報が格納されているディレクトリエントリの数をいれています。<br />
              9行目はディスクのセクタ数です。フロッピーディスクは2880セクタです。<br />
              10行目はハードディスクだと<code>0xf8</code>、リムーバブルメディア(電源が入っている状態でも取り付けや取り外しができるるもの
              ex:USBメモリ,フロッピー)だと<code>0xf0</code>を指定します。<br />
              11行目は一個のFAT(ファイルやディレクトリについての情報を記録する特殊なシステム領域)あたりのセクタ数を指定しています。<br />
              12行目はトラックという単位が何セクタで構成されているかを指定しています。普通のフロッピーでは18セクタです。<br />
              13行目は磁気ヘッドの数を指定します。<br />
              表と裏があるので2です。<br />
              14行目はこのボリュームの手前に存在するセクタ数で、パーティションを使っていないので0を指定しています。<br />
              15行目はドライブの総セクタ数が<code>0x10000</code>を超えるときにドライブの総セクタ数を指定します。<br />
              今回は超えていないので0を指定しています。<br />
              16行目はBIOSで使われるドライブ番号でフロッピーだと<code>0x00</code>を指定します。<br />
              17行目はWINDOWSで使う領域で当然WINDOWSを使わないので0です。<br />
              18行目は以下三行の設定が存在している場合<code>0x29</code>を指定します。<br />
              19行目はボリュームを識別するための番号で8桁の十六進数で指定します。<br />
              20行目はディスクの名前を11byteの文字列で指定します。<br />
              21行目はフォーマットのタイプを8byteの文字列で指定します。今回はFAT12です。</p>
              <div class="sourceCode" id="cb1"><pre
              class="sourceCode nasm"><code class="sourceCode nasm"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>    <span class="cf">JMP</span>     entry</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">DB</span>      <span class="bn">0x90</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">DB</span>      <span class="st">&quot;HELLOAPC&quot;</span>      <span class="co">; ブートセクタの名前</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">DW</span>      <span class="dv">512</span>             <span class="co">; 1セクタの大きさ</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">DB</span>      <span class="dv">1</span>               <span class="co">; クラスタの大きさ</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">DW</span>      <span class="dv">1</span>               <span class="co">; FATがどこから始まるか</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">DB</span>      <span class="dv">2</span>               <span class="co">; FATの個数</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">DW</span>      <span class="dv">224</span>             <span class="co">; ルートディレクトリ領域の大きさ</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">DW</span>      <span class="dv">2880</span>            <span class="co">; このドライブの大きさ</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">DB</span>      <span class="bn">0xf0</span>            <span class="co">; メディアのタイプ</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">DW</span>      <span class="dv">9</span>               <span class="co">; FAT領域の長さ</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">DW</span>      <span class="dv">18</span>              <span class="co">; 1トラックにいくつのセクタがあるか</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">DW</span>      <span class="dv">2</span>               <span class="co">; ヘッドの数</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">DD</span>      <span class="dv">0</span>               <span class="co">; パーティションを使ってないため0</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">DD</span>      <span class="dv">0</span>               <span class="co">; 総セクタ数&lt;0x10000より0</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">DB</span>      <span class="bn">0x00</span>            <span class="co">; フロッピーディスクでは0x00</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">DB</span>      <span class="dv">0</span>               <span class="co">; WindowsNT予約領域</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">DB</span>      <span class="bn">0x29</span>            <span class="co">; 下の3つの設定が存在することを示す。</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">DD</span>      <span class="bn">0xffffffff</span>      <span class="co">; ボリュームシリアル番号</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">DB</span>      <span class="st">&quot;APC        &quot;</span>   <span class="co">; ディスクの名前（11バイト）</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">DB</span>      <span class="st">&quot;FAT12   &quot;</span>      <span class="co">; フォーマットの名前（8バイト）       </span></span></code></pre></div>
              <p>何行目に何をしているかはわかったけど<code>DB</code>やら<code>DD</code>やら<code>DW</code>は何だと思われたかと思います。<code>DB</code>はファイルに1byte書き込むという命令です。<code>DW</code>は2byte、<code>DD</code>は4byteです。<br />
              それじゃあ<code>DB "HELLOAPC"</code>などのDBのあとに文字列が来るものは何だ、明らかに1byteではないじゃないかと感じると思いますが<code>DB "文字列"</code>とすると文字列を構成するそれぞれの文字の文字コードをしらべて1byteずつ書き込んでくれるようになっています。<br />
              また0xで始まる数字はそれが16進数であることを示しています。0x12は10進数で18です。</p>
              <p>ここから先がプログラムとなっていてここではレジスタに0を代入して初期化しています。<br />
              レジスタとはCPUの中にある高速な記憶装置のことです。<br />
              <code>MOV A,B</code>はAにBを代入するという命令です。</p>
              <div class="sourceCode" id="cb2"><pre
              class="sourceCode nasm"><code class="sourceCode nasm"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">entry:</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>        <span class="kw">MOV</span>     <span class="kw">AX</span><span class="op">,</span><span class="dv">0</span>    </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">MOV</span>     <span class="kw">DS</span><span class="op">,</span><span class="kw">AX</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">MOV</span>     <span class="kw">ES</span><span class="op">,</span><span class="kw">AX</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">MOV</span>     <span class="kw">SS</span><span class="op">,</span><span class="kw">AX</span></span></code></pre></div>
              <p>次に1行目であとに書いてある表示するメッセージの最初のメモリの番地をSIレジスタに代入しています。<br />
              msgがフロッピーの中のどこの番地に当たるのかを計算してその番地がSIに代入されます。<br />
              そこから先はAXとBSレジスタにテキストVRAMの領域の最初の番地を代入して、後々使うのでBXレジスタに0x0000を代入しています。</p>
              <div class="sourceCode" id="cb3"><pre
              class="sourceCode nasm"><code class="sourceCode nasm"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print:</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>        <span class="kw">MOV</span>     <span class="kw">SI</span><span class="op">,</span>msg      </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">MOV</span>     <span class="kw">AX</span><span class="op">,</span><span class="bn">0xa000</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">MOV</span>     <span class="kw">ES</span><span class="op">,</span><span class="kw">AX</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">MOV</span>     <span class="kw">BX</span><span class="op">,</span><span class="bn">0x0000</span></span></code></pre></div>
              <p>ここではまず1行目でALレジスタに次に書き込む文字のメモリ番地の中身(=文字コード)を代入しています。[]で囲むとメモリの番地を意味します。その中に<code>CS:SI</code>とありますが、これはCS*16+SIのメモリ番地を指定するという意味です。CS*16がこのプログラムが格納されているメモリーの番地を指すのでそこに文字データのFD内での番地を足すことで次に書き込まれる文字の番地を指定しています。
              2,3行目はもしすべての文字をテキストVRAMに書き終わっているのなら<code>fin:</code>に飛ぶという命令です。
              2行目でALと0を比較するという命令をして、3行目でもし<code>AL=0</code>であったら<code>fin:</code>に飛ぶという命令をしています。
              なぜこれで書き終わっていることを検知できるかといえば、後述する文字データが書かれている部分を見るとすべての文字列のあとに<code>0x0</code>を書き込んであります。一文字ずつ書き込んでいった後<code>0x0</code>が現れたことを確認して文字の書き込みが終わったことを検知しています。
              4行目で実際にテキストVRAMに文字を書き込んでいます。<code>[ES:BX]</code>で書き込むべきメモリ番地を指定して(ESにはテキストVRAMの最初の番地が入っていてBXにはテキストVRAMの中で何バイト目に書き込む必要があるかが入っています)、さきほどALに文字コードを代入したのでそれを書き込んでいます。
              5行目でSIに1を加えることで次の文字のFD内での番地がSIに入ります
              6行目ではテキストVRAMの中での番地を1文字あたり2byte使うため2進めています。
              7行目で<code>putloop:</code>に戻ってループしています。これによってまた次の文字の書き込みが始まります。</p>
              <div class="sourceCode" id="cb4"><pre
              class="sourceCode nasm"><code class="sourceCode nasm"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">putloop:</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>        <span class="kw">MOV</span>     <span class="kw">AL</span><span class="op">,[</span><span class="kw">CS</span><span class="op">:</span><span class="kw">SI</span><span class="op">]</span>                      </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">CMP</span>     <span class="kw">AL</span><span class="op">,</span><span class="dv">0</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">JZ</span>      fin</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">MOV</span>     <span class="op">[</span><span class="kw">ES</span><span class="op">:</span><span class="kw">BX</span><span class="op">],</span><span class="kw">AL</span>  </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">INC</span>     <span class="kw">SI</span>          </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">ADD</span>     <span class="kw">BX</span><span class="op">,</span><span class="dv">2</span>        </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">JMP</span>     putloop</span></code></pre></div>
              <p>前述した通り文字をテキストVRAMに書き終わったら<code>fin:</code>に飛んでくるのでCPUを待機状態にします。</p>
              <div class="sourceCode" id="cb5"><pre
              class="sourceCode nasm"><code class="sourceCode nasm"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fin:</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>        <span class="kw">HLT</span>             </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">JMP</span>     fin     </span></code></pre></div>
              <p>ここに実際に表示する文字列が書き込まれています。前述した通り文字列の後に書き込まれている<code>0x0</code>によってテキストVRAMへの書き込みが終わったことを検知しています。</p>
              <div class="sourceCode" id="cb6"><pre
              class="sourceCode nasm"><code class="sourceCode nasm"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">msg:</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>        <span class="dt">DB</span> <span class="st">&quot;THANK YOU FOR COMING TO APC&quot;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        <span class="dt">DB</span> <span class="st">&quot;  -Asano Physics Club 2022-&quot;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">DB</span> <span class="bn">0x0</span></span></code></pre></div>
              <p>最後に0x400までを0x00で埋める命令を実行しています。
              $はこの行が先頭から何バイト目であるかを教えてくれる変数です。
              0x400からそれを引くことによって何バイトを0x00で埋めればいいかを調べています。</p>
              <div class="sourceCode" id="cb7"><pre
              class="sourceCode nasm"><code class="sourceCode nasm"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">RESB</span>    <span class="bn">0x400</span><span class="op">-$</span>     </span></code></pre></div>
              <h2 id="実際に動かす">実際に動かす</h2>
              <p><a href="https://github.com/asanobuturi/PC98APCOS"
              class="uri">https://github.com/asanobuturi/PC98APCOS</a>に実行方法が書いてあります。</p>
              <h2 id="参考文献">参考文献</h2>
              <p>川合秀美.30日でできるOS自作入門.マイナビ出版,2006<br />
              <a
              href="https://qiita.com/TakedaHiromasa/items/371503c48ac33237a859"
              class="uri">https://qiita.com/TakedaHiromasa/items/371503c48ac33237a859</a><br />
              <a
              href="https://github.com/TakedaHiromasa/HelloWorld-PC98"
              class="uri">https://github.com/TakedaHiromasa/HelloWorld-PC98</a><br />
              <a href="http://elm-chan.org/docs/fat.html"
              class="uri">http://elm-chan.org/docs/fat.html</a></p>
              <h2 id="おわりに">おわりに</h2>
              <p>展示用に作ったものの解説をしてみました。正直説明がわかりにくかったり、意味をあいまいにしている部分もあったと思います。すみません。ここまで読んでくださりありがとうございました。</p>
              <h2 id="ライセンス">ライセンス</h2>
              <p><a
              href="https://github.com/TakedaHiromasa/HelloWorld-PC98"
              class="uri">https://github.com/TakedaHiromasa/HelloWorld-PC98</a>のソースコードを改造して作らせていただきました。以下にライセンス表記があります。</p>
              <p>MIT License</p>
              <p>Copyright (c) 2018</p>
              <p>Permission is hereby granted, free of charge, to any
              person obtaining a copy of this software and associated
              documentation files (the “Software”), to deal in the
              Software without restriction, including without limitation
              the rights to use, copy, modify, merge, publish,
              distribute, sublicense, and/or sell copies of the
              Software, and to permit persons to whom the Software is
              furnished to do so, subject to the following
              conditions:</p>
            </div>
            <nav class="nextPrev">
            </nav>
        </article></div>
        <nav id="sidebar">
            <div id="sidemenu">
            </div>
            <div id="indexblock">
                <div class="indextitle">目次</div>
                <ol class="indexcontents">
                    <ul>
                    <li><a href="#はじめに"
                    id="toc-はじめに">はじめに</a></li>
                    <li><a href="#実際の展示"
                    id="toc-実際の展示">実際の展示</a></li>
                    <li><a href="#基本的なプログラムの仕組み"
                    id="toc-基本的なプログラムの仕組み">基本的なプログラムの仕組み</a></li>
                    <li><a href="#実際のコード"
                    id="toc-実際のコード">実際のコード</a></li>
                    <li><a href="#実際に動かす"
                    id="toc-実際に動かす">実際に動かす</a></li>
                    <li><a href="#参考文献"
                    id="toc-参考文献">参考文献</a></li>
                    <li><a href="#おわりに"
                    id="toc-おわりに">おわりに</a></li>
                    <li><a href="#ライセンス"
                    id="toc-ライセンス">ライセンス</a></li>
                    </ul>
                </ol>
            </div>
        </nav>
    </div>
    <footer class="footer">
        <div class="">
            <p class="copyright">&copy; 2015-2022 Asano Physics Club</p>
        </div>
    </footer>
</main>
<script type="text/javascript" src="/general.js"></script>
<script type="text/javascript" src="/document/document.js"></script>
</body>
</html>
