<!doctype html><html lang=ja><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=description content="文化祭で展示した鍵盤ハーモニカの自動演奏装置について"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/styles.css><link rel=subresource class=lazy-css href=/css/highlight.css><link rel=icon href=/image/favicon.svg type=image/svg+xml><link rel="icon alternate" href=/image/favicon.ico><meta property="og:site_name" content="浅野学園物理部"><meta property="og:url" content="https://asanobuturi.github.io/document/2017/3/index.html"><meta property="og:title" content="自動演奏装置について｜浅野学園物理部"><meta property="og:description" content="文化祭で展示した鍵盤ハーモニカの自動演奏装置について"><meta property="og:type" content="website"><meta property="og:image" content="https://asanobuturi.github.io/document/2017/3/thumbnail.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@Uchi54_APC"><script src=/general.js></script><link rel=stylesheet href=/css/article.css><link rel=stylesheet href=/css/tableOfContents.css><script src=https://kit.fontawesome.com/1e291c4f9b.js crossorigin=anonymous></script><title>自動演奏装置について｜浅野学園物理部</title><script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML"></script></head><body><div id=nav-drawer><input id=nav-input type=checkbox class=nav-unshown>
<label id=nav-open for=nav-input><span class="bar bar1"></span><span class="bar bar2"></span><span class="bar bar3"></span><span class=menu>MENU</span>
<span class=close>CLOSE</span></label>
<label id=nav-close for=nav-input></label><div id=nav-content><a href=/index.html><img loading=lazy src=/image/favicon.svg id=nav-logo alt=浅野学園物理部></a>
<a class=nav-link href=/index.html>ホーム</a>
<a class=nav-link href=/about/index.html>物理部とは</a>
<a class="nav-link isActive" href=/document/index.html>部誌</a>
<a class=nav-link href=/game/index.html>ゲーム</a>
<a class=nav-link href=/blog/index.html>ブログ</a>
<a class=nav-link href=/electronic/index.html>電工の部屋</a><div class=nav-separator></div><a class=nav-link href=/credit/index.html>クレジット(ライセンス)</a></div></div><main><div id=main><div class=documentcontent><div id=breadcrumbs><a href=/index.html><img src=/image/icons/home-solid.svg class=inline-image>ホーム</a>
<img src=/image/icons/angle-right-solid.svg class=inline-image><a href=../../index.html>部誌</a>
<img src=/image/icons/angle-right-solid.svg class=inline-image><a href=../index.html>2017年度部誌</a>
<img src=/image/icons/angle-right-solid.svg class=inline-image><a href=./index.html>自動演奏装置について</a></div><header class=documenttitle><h1 id=title>自動演奏装置について</h1><p class=author><img src=/image/icons/user-edit-solid.svg class=inline-image>高二 K</p><div class=share><a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class=twitter-share-button data-related=Uchi54_apc data-lang=ja data-show-count=false>Tweet</a>
<script async src=https://platform.twitter.com/widgets.js></script></div></header><div class=document><p>今回は今年作った「自動演奏装置」について書いていきたいと思います。去年作ったリコーダーのリベンジですね。去年に比べてそれなりのものができたと思います。いやぁ、去年は酷かった。ずっと尺八吹いてるみたいな感じになってしまいました。教師にもその後の授業でなんか言われるしあれでしたんで</p><p>今年は色々と改善&mldr;というか根本から見直しして作り直しました。まあ、ともかく物理部展#2017をよろしくお願いします</p><h2 id=製作動機>製作動機</h2><p>一番は去年のような無様な真似はしたくないというのが一番でしょう。去年の敗因はリコーダーの穴をしっかり抑えられなかったのと、空気をただ吹き込んでも音が出るということだと思います。それを防ぐために、もっとも効果的な策はリコーダーを諦めるということでした。というか去年とある動画を丸パクし過ぎました。</p><p>そこでたどり着いたのが「メロディオン」です。空気をただ流し込んでも音もでない、鍵盤超押しやすい、和音もでる。リコーダーに何一つ劣っている点がないね！！</p><p>というわけで、メロディオンを用いた自動演奏装置を作ることに決めたのです。</p><h2 id=材料>材料</h2><ul><li>ソレノイド × 32個</li><li>2SK2233 × 33個</li><li>150Ω × 33個</li><li>22kΩ × 33個</li><li>リレー × 1個</li><li>TLP627-4 × 9個</li><li>Arduino Mega 2560 × 1</li><li>エアーコンプレッサー × 1</li><li>メロディオン × 1</li><li>木材 × 適量</li><li>バルブ × 2個</li><li>PC x 1個</li><li>愛情 × <ruby>∞<rp>（</rp><rt>ムゲンダイ</rt><rp>）</rp></ruby></li></ul><h3 id=部品の説明>部品の説明</h3><p>ソレノイドとは、電磁石の力で鉄の棒を上下させる部品です。鍵盤を押す部品ですね。2SK2233はトランジスタ(のようなもの)です。Arduinoから出力される電流が小さいのでそれを増幅する部品です。150Ω、22kΩは抵抗です。電流の勢いを落とします。安全装置ですね。リレーは遮断装置です。バルブに流す電流がすごいので、それを使って処理回路と遮断します。</p><p>TLP627-4は安全装置です。Arduinoは繊細な部品なので、それを守ります。Arduino Mega2560は処理装置です。PCから出力された音楽の信号を電気信号に変えます。エアーコンプレッサーは空気送り機です。メロディオンに空気を供給します。メロディオンは楽器です。愛情は説明不要でしょう。愛なくしては原因不明のエラーに耐えられません。</p><h2 id=how-to-動作>How to 動作</h2><p>パソコンで楽譜データを数字に変換(俗に言うMIDI)し、その数字をArduinoに送り、Arduinoでこの数字のときはドの音、この数字のときはレの音&mldr;&mldr;と先に教えておいて、その数字が来たら、その音を出す鍵盤を押すソレノイドに信号を出します。</p><p>実際はArduinoとソレノイドの間には安全装置と増幅装置を挟んでいます。後、和音のときや極端に低い音の時などはバルブにも命令を出し、流れる空気の量を増やすようにしています。</p><h2 id=回路図>回路図</h2><p><img src=circuit.jpg alt=回路図></p><h2 id=anduino-に書き込んだプログラム>Anduino に書き込んだプログラム</h2><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;MIDI.I&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;Servo.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
Servo servol;

<span style=color:#66d9ef>int</span> Pin[<span style=color:#ae81ff>54</span>]<span style=color:#f92672>=</span>{};
unsigrred <span style=color:#66d9ef>long</span> DownTime[<span style=color:#ae81ff>54</span>]<span style=color:#f92672>=</span>{};
<span style=color:#66d9ef>int</span> Channel;

MIDI_CREATE_DEFAULT_INSTANCE();

<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setup</span>(){
    servolattach(<span style=color:#ae81ff>7</span>);
    <span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> i<span style=color:#f92672>=</span><span style=color:#ae81ff>22</span>;i<span style=color:#f92672>&lt;=</span><span style=color:#ae81ff>53</span>;i<span style=color:#f92672>++</span>){
        pinVode(i, OUTPUT);
    }
    MIDI.begin();
    Serial.begin(<span style=color:#ae81ff>115200</span>);
}

<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>loop</span>(){
    midireadplay();
}

<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>GetPinNum</span>(<span style=color:#66d9ef>int</span> NoteNum){
    <span style=color:#66d9ef>if</span>(Note Num<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>53</span>){
        <span style=color:#66d9ef>return</span> (NoteNum<span style=color:#f92672>+</span><span style=color:#ae81ff>7</span>)<span style=color:#f92672>%</span><span style=color:#ae81ff>12</span><span style=color:#f92672>+</span><span style=color:#ae81ff>22</span>;
    }<span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span>(NoteNum<span style=color:#f92672>&lt;=</span><span style=color:#ae81ff>84</span>){
        retum Note Num<span style=color:#f92672>-</span><span style=color:#ae81ff>53</span><span style=color:#f92672>+</span><span style=color:#ae81ff>22</span>;
    }<span style=color:#66d9ef>else</span>{
        retum (Note Num<span style=color:#f92672>-</span><span style=color:#ae81ff>85</span>)<span style=color:#f92672>%</span><span style=color:#ae81ff>12</span><span style=color:#f92672>+</span><span style=color:#ae81ff>42</span>;
    }
}

<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>GetMicroDeg</span>(<span style=color:#66d9ef>double</span> Deg){
    Deg<span style=color:#f92672>+=</span><span style=color:#ae81ff>10</span>;
    <span style=color:#66d9ef>if</span>(Deg<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>0</span>)Deg<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
    <span style=color:#66d9ef>if</span>(Deg<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>180</span>)Deg<span style=color:#f92672>=</span><span style=color:#ae81ff>180</span>;
    <span style=color:#66d9ef>int</span> minw<span style=color:#f92672>=</span>MAX_PULSE WIDTH;
    <span style=color:#66d9ef>int</span> maxw<span style=color:#f92672>=</span>MIN_PULSE_WIDTH;
    retum minw<span style=color:#f92672>+</span>Deg<span style=color:#f92672>*</span>(maxw<span style=color:#f92672>-</span>minw)<span style=color:#f92672>/</span><span style=color:#ae81ff>180</span>;
}

<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>midireadplay</span>() {
    MIDI.setInputChannel(t);
    <span style=color:#66d9ef>if</span> (MIDI.read()){
        uint8_t datal <span style=color:#f92672>=</span> MIDI.getData();<span style=color:#75715e>// note no
</span><span style=color:#75715e></span>        uint8_t data2 <span style=color:#f92672>-</span> MIDI.getData2(); <span style=color:#75715e>// velocity
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>int</span> PinNum<span style=color:#f92672>=</span>GetPinNum(datal);

        <span style=color:#66d9ef>switch</span> (MIDI.getType()){
        <span style=color:#66d9ef>case</span> Ox90:
            <span style=color:#66d9ef>if</span> (data2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>){
                digitalWrite(PinNum LOW);
                Pin[PinNum]<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
            }<span style=color:#66d9ef>else</span>{
                digitalWrite(PinNum,HIGH);
                Pin[Pintum]<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>;
                DownTime[Pinhum]<span style=color:#f92672>=</span>millis();
            }
            <span style=color:#66d9ef>break</span>;
        <span style=color:#66d9ef>case</span> Ox80:
            digitalrite(PinNum,LOW);
            Pin[PinNum]<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
            <span style=color:#66d9ef>break</span>;
        }
    }

    <span style=color:#75715e>//長い間下がっているピンを上げる
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> i<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>i<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>54</span>j<span style=color:#f92672>++</span>){
        <span style=color:#66d9ef>if</span>(Pin[i]<span style=color:#f92672>==</span><span style=color:#ae81ff>1</span><span style=color:#f92672>&amp;&amp;</span>DownTime[i]<span style=color:#f92672>!=</span><span style=color:#ae81ff>0</span><span style=color:#f92672>&amp;&amp;</span>millis()<span style=color:#f92672>-</span>DownTime[i]<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>10000</span>){
            digitalWrite(i,LOW);
            Pin[i]<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
        }
    }
    <span style=color:#75715e>//下がっているピンの数を数える
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> OnPinNum<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
    <span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> i<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;i<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>54</span>;i<span style=color:#f92672>++</span>){<span style=color:#66d9ef>if</span>(Pin[i]<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>){OnPinNum<span style=color:#f92672>++</span>;}}

    servol.writeMicroseconds(GetMicroDeg(OnPinNum<span style=color:#f92672>*</span><span style=color:#ae81ff>8</span>));
}
</code></pre></td></tr></table></div></div><h2 id=後書き>後書き</h2><p>え～、長々と興味の無い人には本当につまらない話をしてしまってすいませんでした。あ、ここまで目を通す人は興味のある人しかいないから大丈夫かな。私にとっては最後の文化祭であり、動画から発想を得た以外は基本的に自分で考えた作品を作れたので満足です。(とっても簡単なんですけどね&mldr;)</p><p>物理部展#2017にお越しいただき誠にありがとうございます。また来年、来て頂けるとうれしいです。</p></div><nav class=nextPrev><div class=next>次へ<a href=https://asanobuturi.github.io/document/2017/4/>"Arduino"とは何ぞや？＞</a></div><div class=next>前へ<a href=https://asanobuturi.github.io/document/2017/2/>"落ちる"動きと当たり判定のプログラミングについて＞</a></div></nav></div><nav id=sidebar><div id=sidemenu><div class=side-back><a href=../index.html>記事の一覧へもどる<img src=/image/icons/sign-out-alt-solid.svg class=inline-image></a></div><div class=side-prev><a href=https://asanobuturi.github.io/document/2017/2/><img src=/image/icons/angle-left-solid.svg class=inline-image>"落ちる"動きと当たり判定のプログラミングについて</a></div><div class=side-next><a href=https://asanobuturi.github.io/document/2017/4/>"Arduino"とは何ぞや？<img src=/image/icons/angle-right-solid.svg class=inline-image></a></div></div><div id=indexblock><div class=indextitle>目次</div><ol class=indexcontents><nav id=TableOfContents><ul><li><a href=#製作動機>製作動機</a></li><li><a href=#材料>材料</a><ul><li><a href=#部品の説明>部品の説明</a></li></ul></li><li><a href=#how-to-動作>How to 動作</a></li><li><a href=#回路図>回路図</a></li><li><a href=#anduino-に書き込んだプログラム>Anduino に書き込んだプログラム</a></li><li><a href=#後書き>後書き</a></li></ul></nav></ol></div></nav></div><footer class=footer><p class=copyright>Copyright &copy; 2015 - 2022 Asano Physics Club, All Rights Reversed.</p></footer></main></body></html>