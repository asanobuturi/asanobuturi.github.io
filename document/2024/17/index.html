<!doctype html><html lang=ja><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=description content><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/scss/styles.min.4a71567d35f0565714f9b264f620dd2c5abcdd3fd6d8bc1fe2bafa8114c2fe47.css><link rel=icon href=/image/favicon.svg type=image/svg+xml><link rel="icon alternate" href=/image/favicon.ico><meta property="og:site_name" content="浅野学園物理部"><meta property="og:url" content="https://asanobuturi.github.io/document/2024/17/index.html"><meta property="og:title" content="かの邪智暴虐なAlphabet Inc.を除こう｜浅野学園物理部"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:image" content="https://asanobuturi.github.io/document/2024/17/thumbnail.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@Uchi54_APC"><link rel=canonical href=https://asanobuturi.github.io/document/2024/17/><script async src="https://www.googletagmanager.com/gtag/js?id=G-M4YH1E5WC1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-M4YH1E5WC1")</script><title>かの邪智暴虐なAlphabet Inc.を除こう｜浅野学園物理部</title><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<link rel=stylesheet href=/scss/highlight.min.5fd4e02a806db4bd8e63d97db9f23a937f07d0d2478a4e37b851c96e75701cf4.css><link rel=stylesheet href=/scss/article.min.5ee3cae303b380c098ecc9cafc8ef5f27c4e7d9864fa43a00560f808df467ab1.css><link rel=stylesheet href=/scss/tableOfContents.min.603245923695f62c9be0618c1b6a10599acbf0f4f5056ffe631acd014b70fd17.css></head><body><nav id=nav-drawer><input id=nav-input type=checkbox class=nav-unshown>
<label id=nav-open for=nav-input><span class="bar bar1"></span>
<span class="bar bar2"></span>
<span class="bar bar3"></span>
<span class=menu>MENU</span>
<span class=close>CLOSE</span></label>
<label id=nav-close for=nav-input></label><div id=nav-content><a href=/index.html><img loading=lazy src=/image/favicon.svg id=nav-logo alt=浅野学園物理部></a>
<a class=nav-link href=/index.html>ホーム</a>
<a class=nav-link href=/about/index.html>物理部とは</a>
<a class="nav-link isActive" href=/document/index.html>部誌</a>
<a class=nav-link href=/game/index.html>ゲーム</a>
<a class=nav-link href=/blog/index.html>ブログ</a>
<a class=nav-link href=/electronic/index.html>電工の部屋</a><hr><a class=nav-link href=/credit/index.html>クレジット(ライセンス)</a></div></nav><main><div id=content><a name=top></a><div id=breadcrumbs><a href=/index.html><img src=/image/icons/home-solid.svg class=inline-image>ホーム</a>
<img src=/image/icons/angle-right-solid.svg class=inline-image>
<a href=/document/>部誌</a>
<img src=/image/icons/angle-right-solid.svg class=inline-image>
<a href=/document/2024/>2024年度・部誌</a>
<img src=/image/icons/angle-right-solid.svg class=inline-image>
<a href=/document/2024/17/>かの邪智暴虐なAlphabet Inc.を除こう</a></div><header id=overview><h1 id=title>かの邪智暴虐なAlphabet Inc.を除こう</h1><div><div class=properties></div><div class=share><span><a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class=twitter-share-button data-related=Uchi54_apc data-lang=ja data-show-count=false>Tweet</a>
<script async src=https://platform.twitter.com/widgets.js></script></span></div></div></header><article><h2 id=まえがき>まえがき</h2><p>生活に不便を感じたらその不便さを<code>wrap</code>するためにラッパライブラリ等を作ることが私のプログラミングの動機となることが多く、</p><ul><li>写真を<code>写真.app</code>で管理していたが<code>Python</code>などのスクリプトを使った一括編集などが難しいため<code>Django</code>を用いて自作</li><li>画像の変換が右クリメニューからできるソフトがあるのだが<code>.avif</code>や<code>.webp</code>など次世代形式に対応していないため自作</li><li>SNSの交換の際にQRコードそのものが送られてくることが多々あったので画面上のQRコードを読み取りクリップボードにコピーするソフトを自作</li><li>マイクラ鯖の<code>rcon</code>が生では使いにくすぎたので<code>Django</code>でラッパを自作</li></ul><p>などのツール系の自作が多くくも、去年はPC98でマインスイーパを自作しその続きをやろうと思っていたが、文化祭片付け後にPC98が死亡していたためジョークRFCのパロディでも書こうと思っていたのだが面白さがイマイチ伸びなかった上PC98を秋葉原最終処分場。で二台購入し動作確認もしたため<code>PONG</code>でも作る気概であったけれども夏休みが多忙を極めていた<del>挙句外が暑すぎて部活に行きたくなかった</del>ので簡単に作れそうな</p><ul><li>Google Mapの<code>location-history.json</code>を解析して地図に表示するツール</li></ul><p>を自作することとした。</p><h2 id=献立>献立</h2><p>実行されたらオプションを解析、不足しているなら対話シェルを呼び出しユーザに情報を求める。その後はデータを解析しブラウザに表示し待機、ブラウザのタブが閉じられたらプログラム終了となる。また、急いで製作したものであるので、大半が「なんか知らんけど動いた」ゾーンに属していることを留意してもらいたい。</p><h2 id=utilpy-loggerpy>util.py, logger.py</h2><p>ベクトル計算の支援を主とするライブラリとロギング用のライブラリを自作して使用している。<code>util.py</code>にて定義されている<code>Vector</code>ついて解説すると、<code>Vector</code>は四則演算が大体行列計算と同じものとなる。ただし、乗算は横ベクトルと縦ベクトルの積として計算される。つまり<code>Vector(a,b)*Vector(x,y)=Vector(ax,by)</code>となり、除算もこれに倣う。<code>logger.py</code>は、ほぼ想像できるような内容しか書かれていないので深くは解説しないが、<code>StreamHandler</code>と<code>FileHandler</code>で標準入出力とファイルにログを流している。</p><h2 id=解析>解析</h2><p><code>location-history.json</code>は<code>activity</code>,<code>timelinePath</code>,<code>visit</code>の三種類うちどれか一つを持つデータの配列であり、<code>activity</code>は移動手段と移動元/先の座標、<code>timelinePath</code>は移動時のパス、<code>visit</code>は訪れた定点と訪れた時間帯が記録してある。今回移動手段はあまり気にしていない上Googleの推測が精度を欠いており、海上を車で移動していたりするので移動は<code>timelinePath</code>を採用した。</p><p>座標は全て<code>"geo:&lt;lat>,&lt;lng>"</code>という形式で記録されていたので、<code>geo_resolver</code>関数を作成し効率化を図った。</p><div class=codeblock><div class=codeblock-name>main.py</div><div class=codeblock-content><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>geo_resolver</span>(text: str) <span style=color:#f92672>-&gt;</span> Vector[float, float]:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;geo:lat,lng&#34; -&gt; (lat, lng)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Vector(map(float, text[<span style=color:#ae81ff>4</span>:]<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;,&#34;</span>)))</span></span></code></pre></td></tr></table></div></div></div></div><p>また、データの特性上<code>(datetime, (lat, lng))</code>という形式のオブジェクトを扱う機会が多いので<code>NamedTuple</code>を利用してリーダブルなコードにした。</p><div class=codeblock><div class=codeblock-name>main.py</div><div class=codeblock-content><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Visit</span>(NamedTuple):
</span></span><span style=display:flex><span>    dt: datetime<span style=color:#f92672>.</span>datetime
</span></span><span style=display:flex><span>    pos: Vector[float, float]</span></span></code></pre></td></tr></table></div></div></div></div><p><code>markers</code>辞書は同じ座標の<code>marker</code>が重なって読めないという事態を防ぐために座標をキーにした辞書型で格納しその後<code>for</code>を回して<code>folium.Map</code>に載せている。座標をキーにする際に処理を簡潔に<code>.append()</code>で済ませるために<code>defaultdict</code>を使用した。</p><div class=codeblock><div class=codeblock-name>main.py</div><div class=codeblock-content><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>    markers <span style=color:#f92672>=</span> defaultdict(list)</span></span></code></pre></td></tr></table></div></div></div></div><div class=codeblock><div class=codeblock-content><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">169
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>                markers[<span style=color:#e6db74>&#34;,&#34;</span><span style=color:#f92672>.</span>join(list(map(str,p)))]<span style=color:#f92672>.</span>append(tooltip)</span></span></code></pre></td></tr></table></div></div></div></div><div class=codeblock><div class=codeblock-content><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">187
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">188
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>        <span style=color:#66d9ef>for</span> pos <span style=color:#f92672>in</span> markers:
</span></span><span style=display:flex><span>            folium<span style=color:#f92672>.</span>Marker(tuple(map(float, pos<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;,&#34;</span>))), tooltip<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;,&#34;</span><span style=color:#f92672>.</span>join(markers[pos]), popup<span style=color:#f92672>=</span>pos)<span style=color:#f92672>.</span>add_to(fmap)</span></span></code></pre></td></tr></table></div></div></div></div><hr><p>また、データ構造の記述時に<code>&lt;float></code>などが記述されているが全て値はダブルクオーテーションで括られていることは記載していない。</p><h3 id=timelinepath><code>timelinePath</code></h3><h4 id=データ構造>データ構造</h4><div class=codeblock><div class=codeblock-content><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;endTime&#34;</span>: <span style=color:#960050;background-color:#1e0010>&lt;ISO</span> <span style=color:#ae81ff>8601</span> <span style=color:#960050;background-color:#1e0010>EDTF&gt;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;startTime&#34;</span>: <span style=color:#960050;background-color:#1e0010>&lt;ISO</span> <span style=color:#ae81ff>8601</span> <span style=color:#960050;background-color:#1e0010>EDTF&gt;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;timelinePath&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;point&#34;</span>: <span style=color:#e6db74>&#34;geo:&lt;lat&gt;,&lt;lng&gt;&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;durationMinutesOffsetFromStartTime&#34;</span>: <span style=color:#960050;background-color:#1e0010>&lt;int&gt;</span>
</span></span><span style=display:flex><span>        },<span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div></div></div><p><code>timelinePath</code>は現地時間で記録されているので<code>datetime.timedelta</code>を加算して時差補正をする必要がない。<code>startTime</code>から<code>durationMinutesOffsetFromStartTime</code>分後の<code>lat</code>と<code>lng</code>が格納されている。</p><h4 id=解析-1>解析</h4><div class=codeblock><div class=codeblock-name>main.py</div><div class=codeblock-content><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>for</span> pts <span style=color:#f92672>in</span> d[<span style=color:#e6db74>&#34;timelinePath&#34;</span>]:
</span></span><span style=display:flex><span>    p <span style=color:#f92672>=</span> geo_resolver(pts[<span style=color:#e6db74>&#34;point&#34;</span>])
</span></span><span style=display:flex><span>    t <span style=color:#f92672>=</span> sdtm<span style=color:#f92672>+</span>datetime<span style=color:#f92672>.</span>timedelta(minutes<span style=color:#f92672>=</span>int(pts[<span style=color:#e6db74>&#34;durationMinutesOffsetFromStartTime&#34;</span>]))
</span></span><span style=display:flex><span>    <span style=color:#75715e># markers[&#34;,&#34;.join(list(map(str,p)))].append(f&#34;{t.strftime(&#34;%H:%M&#34;)}&#34;) # for debug</span>
</span></span><span style=display:flex><span>    points<span style=color:#f92672>.</span>append(Visit(normalize(t), p))</span></span></code></pre></td></tr></table></div></div></div></div><p><code>for</code>ループを回して<code>points</code>に格納。以上。</p><h3 id=visit><code>visit</code></h3><h4 id=データ構造-1>データ構造</h4><div class=codeblock><div class=codeblock-content><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;endTime&#34;</span>: <span style=color:#960050;background-color:#1e0010>&lt;ISO</span> <span style=color:#ae81ff>8601</span> <span style=color:#960050;background-color:#1e0010>EDTF&gt;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;startTime&#34;</span>: <span style=color:#960050;background-color:#1e0010>&lt;ISO</span> <span style=color:#ae81ff>8601</span> <span style=color:#960050;background-color:#1e0010>EDTF&gt;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;visit&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;hierarchyLevel&#34;</span>: <span style=color:#960050;background-color:#1e0010>&lt;bool&gt;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;topCandidate&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;probability&#34;</span>: <span style=color:#960050;background-color:#1e0010>&lt;float&gt;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;semanticType&#34;</span>: <span style=color:#960050;background-color:#1e0010>&lt;str&gt;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;placeID&#34;</span>: <span style=color:#960050;background-color:#1e0010>&lt;str&gt;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;placeLocation&#34;</span>: <span style=color:#e6db74>&#34;geo:&lt;lat&gt;,&lt;lng&gt;&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;probability&#34;</span>: <span style=color:#960050;background-color:#1e0010>&lt;float&gt;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div></div></div><h4 id=解析-2>解析</h4><div class=codeblock><div class=codeblock-content><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#34;visit&#34;</span> <span style=color:#f92672>in</span> d:
</span></span><span style=display:flex><span>    t <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>fromisoformat(d[<span style=color:#e6db74>&#34;endTime&#34;</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> t<span style=color:#f92672>.</span>date() <span style=color:#f92672>&gt;</span> day:
</span></span><span style=display:flex><span>        t <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>combine(day, datetime<span style=color:#f92672>.</span>time(<span style=color:#ae81ff>23</span>, <span style=color:#ae81ff>59</span>, <span style=color:#ae81ff>59</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>elif</span> sdtm<span style=color:#f92672>.</span>date() <span style=color:#f92672>&lt;</span> day:
</span></span><span style=display:flex><span>        sdtm <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>combine(day, datetime<span style=color:#f92672>.</span>time(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>    p <span style=color:#f92672>=</span> geo_resolver(d[<span style=color:#e6db74>&#34;visit&#34;</span>][<span style=color:#e6db74>&#34;topCandidate&#34;</span>][<span style=color:#e6db74>&#34;placeLocation&#34;</span>])
</span></span><span style=display:flex><span>    tooltip <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>sdtm<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#34;%H:%M&#34;</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>-</span><span style=color:#e6db74>{</span>t<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#34;%H:%M&#34;</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    markers[<span style=color:#e6db74>&#34;,&#34;</span><span style=color:#f92672>.</span>join(list(map(str,p)))]<span style=color:#f92672>.</span>append(tooltip)
</span></span><span style=display:flex><span>    points<span style=color:#f92672>.</span>append(Visit(normalize(t), p))</span></span></code></pre></td></tr></table></div></div></div></div><p>前述の<code>timelinePath</code>と比べ僅かに複雑になっている。<code>visit</code>は長時間を記録するため日付をまたぐことが多いのでその日付を補正する部分と、マップ表示用のデータの作成の部分が増えている。</p><h2 id=表示>表示</h2><div class=codeblock><div class=codeblock-content><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>    fmap<span style=color:#f92672>.</span>location <span style=color:#f92672>=</span> points[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>pos
</span></span><span style=display:flex><span>    fmap<span style=color:#f92672>.</span>options[<span style=color:#e6db74>&#34;zoom&#34;</span>] <span style=color:#f92672>=</span> zoom
</span></span><span style=display:flex><span>    folium<span style=color:#f92672>.</span>PolyLine(locations<span style=color:#f92672>=</span>[x[<span style=color:#ae81ff>1</span>] <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> points])<span style=color:#f92672>.</span>add_to(fmap)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> pos <span style=color:#f92672>in</span> markers:
</span></span><span style=display:flex><span>        folium<span style=color:#f92672>.</span>Marker(tuple(map(float, pos<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;,&#34;</span>))), tooltip<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;,&#34;</span><span style=color:#f92672>.</span>join(markers[pos]), popup<span style=color:#f92672>=</span>pos)<span style=color:#f92672>.</span>add_to(fmap)
</span></span><span style=display:flex><span><span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>    exception(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Error while creating map data. Following is points data:</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>points=</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>{</span>pformat(points)<span style=color:#e6db74>}</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>markers=</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>{</span>pformat(markers)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        fname <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>day<span style=color:#e6db74>}</span><span style=color:#e6db74>.html&#34;</span>
</span></span><span style=display:flex><span>        fmap<span style=color:#f92672>.</span>save(fname)
</span></span><span style=display:flex><span>        browser <span style=color:#f92672>=</span> webbrowser<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;&#34;&#34;&#34;C:</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Program Files</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Google</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Chrome</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Application</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>chrome.exe&#34; </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;&#34;&#34;</span>)
</span></span><span style=display:flex><span>        browser<span style=color:#f92672>.</span>open(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;file://</span><span style=color:#e6db74>{</span>os<span style=color:#f92672>.</span>getcwd()<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>{</span>fname<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>        exception(<span style=color:#e6db74>&#34;Error while show html file in browser.&#34;</span>)</span></span></code></pre></td></tr></table></div></div></div></div><p>データがイカれていると表示中にエラーを吐くことが多いので<code>try</code>~<code>except</code>文を使っている。また、<code>Chrome</code>以外のブラウザではエラーで何も表示されないバグがあるそうなので<code>Chrome</code>を名指ししている。<code>defaultdict</code>を回している部分が少し引っかかると思うがそれぐらいだろう。</p><h2 id=おわりに>おわりに</h2><p>締切の日の深夜にこの文を書いているため、最後のほうが駆け足になったことを許してもらいたい。これだけでは「Googleがサ終しなかったら意味ないじゃん」と思うかもしれないが、移動経路のグラフから撮影時間をクエリにして座標を返すプログラムに発展させることができ、これができるとGPSモジュールがついていない一眼の写真にGPS情報をつけることができる。ソースコードの全文は追ってWeb版で公開される思うので、よかったらWeb版も見てもらっていきたい。会場の部屋の何処かでQRコードが配布されていることだろう。</p></article><span class=next>次へ<a href=https://asanobuturi.github.io/document/2024/18/>猫でもわかる電工班＞</a></span><br><span class=prev>前へ<a href=https://asanobuturi.github.io/document/2024/16/>418 I'm a Teapot＞</a></span></div><aside id=sidebar><nav id=sidemenu><div class=side-back><a href=../index.html>記事の一覧へもどる<img src=/image/icons/sign-out-alt-solid.svg class=inline-image></a></div><div class=side-prev><a href=https://asanobuturi.github.io/document/2024/16/><img src=/image/icons/angle-left-solid.svg class=inline-image>418 I'm a Teapot</a></div><div class=side-next><a href=https://asanobuturi.github.io/document/2024/18/>猫でもわかる電工班<img src=/image/icons/angle-right-solid.svg class=inline-image></a></div></nav><section id=indexblock><header class=indextitle>目次</header><nav id=TableOfContents><ul><li><a href=#まえがき>まえがき</a></li><li><a href=#献立>献立</a></li><li><a href=#utilpy-loggerpy>util.py, logger.py</a></li><li><a href=#解析>解析</a><ul><li><a href=#timelinepath><code>timelinePath</code></a></li><li><a href=#visit><code>visit</code></a></li></ul></li><li><a href=#表示>表示</a></li><li><a href=#おわりに>おわりに</a></li></ul></nav></section></aside></main><footer id=footer><div class=section><nav class=grid><div><label class=headline>CONTENT</label><ul><li><a href=/>Home</a></li><li><a href=/document/>Docs</a></li><li><a href=/game/>Games</a></li><li><a href=/blog/>Blog</a></li><li><a href=/electronic/>Electronic</a></li></ul></div><div><label class=headline>CONTACT</label><ul><li><a target=_blank href=https://x.com/Uchi54_apc>X</a></li><li><a target=_blank href=https://github.com/asanobuturi>GitHub Organization</a></li><li><a target=_blank href=https://github.com/asanobuturi/asanobuturi.github.io>Repository</a></li><li><a target=_blank href=https://github.com/asanobuturi/asanobuturi.github.io/issues>Issues</a></li></ul></div><div><label class=headline>ABOUT</label><ul><li><a href=/about/>About Us</a></li></ul></div></nav></div><hr><div class=section><p class=copyright>Copyright &copy; 2015 - 2023 Asano Physics Club, All Rights Reversed.</p><nav class=sns><a target=_blank href=https://twitter.com/Uchi54_apc><svg xmlns="http://www.w3.org/2000/svg" fill="currentcolor" viewBox="0 0 248 204"><path d="M221.95 51.29c.15 2.17.15 4.34.15 6.53.0 66.73-50.8 143.69-143.69 143.69v-.04c-27.44.04-54.31-7.82-77.41-22.64 3.99.48 8 .72 12.02.73 22.74.02 44.83-7.61 62.72-21.66-21.61-.41-40.56-14.5-47.18-35.07 7.57 1.46 15.37 1.16 22.8-.87-23.56-4.76-40.51-25.46-40.51-49.5v-.64c7.02 3.91 14.88 6.08 22.92 6.32C11.58 63.31 4.74 33.79 18.14 10.71c25.64 31.55 63.47 50.73 104.08 52.76-4.07-17.54 1.49-35.92 14.61-48.25 20.34-19.12 52.33-18.14 71.45 2.19 11.31-2.23 22.15-6.38 32.07-12.26-3.77 11.69-11.66 21.62-22.2 27.93 10.01-1.18 19.79-3.86 29-7.95-6.78 10.16-15.32 19.01-25.2 26.16z"/></svg></a><a target=_blank href=https://github.com/asanobuturi><svg class="w-5 h-5" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483.0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951.0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65.0.0.84-.27 2.75 1.026A9.564 9.564.0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688.0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855.0 1.338-.012 2.419-.012 2.747.0.268.18.58.688.482A10.019 10.019.0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/></a></nav></div></footer></body></html>